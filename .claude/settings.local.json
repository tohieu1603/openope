{
  "permissions": {
    "allow": [
      "Bash(npx vitest run --reporter=verbose)",
      "Bash(tee:*)",
      "Bash(npx vitest run)",
      "Bash(npx vitest:*)",
      "Bash(\"D:\\\\Project\\\\SourceCode\\\\agent.operis\\\\apps\\\\windows-desktop\\\\src\\\\__tests__\\\\tray-manager.test.ts\" << 'TESTEOF'\n/**\n * Unit tests for TrayManager\n * Tests tray initialization, status updates, icon mapping, menu structure,\n * quitting flag, and integration with main.ts\n */\nimport { describe, it, expect, beforeEach, afterEach, vi } from \"vitest\";\nimport path from \"node:path\";\nimport fs from \"node:fs\";\nimport type { BrowserWindow } from \"electron\";\n\n// Mock Electron modules  \nvi.mock\\(\"electron\", \\(\\) => {\n  const createMockTrayInstance = \\(\\) => \\({\n    setToolTip: vi.fn\\(\\),\n    setImage: vi.fn\\(\\),\n    setContextMenu: vi.fn\\(\\),\n    on: vi.fn\\(\\),\n    destroy: vi.fn\\(\\),\n  }\\);\n\n  const mockTrayFn = vi.fn\\(createMockTrayInstance\\);\n\n  return {\n    Tray: mockTrayFn,\n    Menu: {\n      buildFromTemplate: vi.fn\\(\\),\n    },\n    app: {\n      isPackaged: false,\n      resourcesPath: \"/app/resources\",\n      getLoginItemSettings: vi.fn\\(\\(\\) => \\({ openAtLogin: false }\\)\\),\n      setLoginItemSettings: vi.fn\\(\\),\n      quit: vi.fn\\(\\),\n    },\n    BrowserWindow: {},\n  };\n}\\);\n\nimport { TrayManager } from \"../tray-manager\";\nimport { Tray, Menu, app } from \"electron\";\n\ndescribe\\(\"TrayManager\", \\(\\) => {\n  let manager: TrayManager;\n  let mockWindow: BrowserWindow;\n\n  beforeEach\\(\\(\\) => {\n    vi.clearAllMocks\\(\\);\n\n    const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n    mockMenuBuildFromTemplate.mockReturnValue\\({}\\);\n\n    mockWindow = {\n      isMinimized: vi.fn\\(\\).mockReturnValue\\(false\\),\n      restore: vi.fn\\(\\),\n      show: vi.fn\\(\\),\n      focus: vi.fn\\(\\),\n      isDestroyed: vi.fn\\(\\).mockReturnValue\\(false\\),\n    } as any;\n\n    manager = new TrayManager\\(\\);\n  }\\);\n\n  afterEach\\(\\(\\) => {\n    if \\(manager\\) {\n      manager.destroy\\(\\);\n    }\n  }\\);\n\n  describe\\(\"Class structure\", \\(\\) => {\n    it\\(\"should have init method\", \\(\\) => {\n      expect\\(typeof manager.init\\).toBe\\(\"function\"\\);\n    }\\);\n\n    it\\(\"should have updateGateway method\", \\(\\) => {\n      expect\\(typeof manager.updateGateway\\).toBe\\(\"function\"\\);\n    }\\);\n\n    it\\(\"should have updateTunnel method\", \\(\\) => {\n      expect\\(typeof manager.updateTunnel\\).toBe\\(\"function\"\\);\n    }\\);\n\n    it\\(\"should have setQuitting method\", \\(\\) => {\n      expect\\(typeof manager.setQuitting\\).toBe\\(\"function\"\\);\n    }\\);\n\n    it\\(\"should have isQuitting getter\", \\(\\) => {\n      expect\\(typeof manager.isQuitting\\).toBe\\(\"boolean\"\\);\n    }\\);\n\n    it\\(\"should have destroy method\", \\(\\) => {\n      expect\\(typeof manager.destroy\\).toBe\\(\"function\"\\);\n    }\\);\n  }\\);\n\n  describe\\(\"Initial state\", \\(\\) => {\n    it\\(\"should have isQuitting = false on creation\", \\(\\) => {\n      expect\\(manager.isQuitting\\).toBe\\(false\\);\n    }\\);\n  }\\);\n\n  describe\\(\"setQuitting/isQuitting\", \\(\\) => {\n    it\\(\"should set isQuitting flag to true\", \\(\\) => {\n      expect\\(manager.isQuitting\\).toBe\\(false\\);\n      manager.setQuitting\\(\\);\n      expect\\(manager.isQuitting\\).toBe\\(true\\);\n    }\\);\n  }\\);\n\n  describe\\(\"ICON_MAP\", \\(\\) => {\n    it\\(\"should map running status to tray-green.ico\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"running\"\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setImage\\).toHaveBeenCalledWith\\(\n        expect.stringContaining\\(\"tray-green.ico\"\\)\n      \\);\n    }\\);\n\n    it\\(\"should map starting status to tray-yellow.ico\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"starting\"\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setImage\\).toHaveBeenCalledWith\\(\n        expect.stringContaining\\(\"tray-yellow.ico\"\\)\n      \\);\n    }\\);\n\n    it\\(\"should map error status to tray-red.ico\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"error\"\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setImage\\).toHaveBeenCalledWith\\(\n        expect.stringContaining\\(\"tray-red.ico\"\\)\n      \\);\n    }\\);\n\n    it\\(\"should map stopped status to tray-gray.ico\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"stopped\"\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setImage\\).toHaveBeenCalledWith\\(\n        expect.stringContaining\\(\"tray-gray.ico\"\\)\n      \\);\n    }\\);\n\n    it\\(\"should use tray-gray.ico as default/initial icon\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      const calls = mockTrayFn.mock.calls;\n      expect\\(calls.some\\(c => c[0]?.includes\\(\"tray-gray.ico\"\\)\\)\\).toBe\\(true\\);\n    }\\);\n  }\\);\n\n  describe\\(\"Tray icon files exist\", \\(\\) => {\n    it\\(\"should have tray-green.ico in resources\", \\(\\) => {\n      const iconPath = path.join\\(__dirname, \"..\", \"..\", \"resources\", \"tray-green.ico\"\\);\n      expect\\(fs.existsSync\\(iconPath\\)\\).toBe\\(true\\);\n    }\\);\n\n    it\\(\"should have tray-yellow.ico in resources\", \\(\\) => {\n      const iconPath = path.join\\(__dirname, \"..\", \"..\", \"resources\", \"tray-yellow.ico\"\\);\n      expect\\(fs.existsSync\\(iconPath\\)\\).toBe\\(true\\);\n    }\\);\n\n    it\\(\"should have tray-red.ico in resources\", \\(\\) => {\n      const iconPath = path.join\\(__dirname, \"..\", \"..\", \"resources\", \"tray-red.ico\"\\);\n      expect\\(fs.existsSync\\(iconPath\\)\\).toBe\\(true\\);\n    }\\);\n\n    it\\(\"should have tray-gray.ico in resources\", \\(\\) => {\n      const iconPath = path.join\\(__dirname, \"..\", \"..\", \"resources\", \"tray-gray.ico\"\\);\n      expect\\(fs.existsSync\\(iconPath\\)\\).toBe\\(true\\);\n    }\\);\n\n    it\\(\"all 4 tray icons exist as files\", \\(\\) => {\n      const icons = [\"tray-green.ico\", \"tray-yellow.ico\", \"tray-red.ico\", \"tray-gray.ico\"];\n      const resourcesDir = path.join\\(__dirname, \"..\", \"..\", \"resources\"\\);\n      icons.forEach\\(icon => {\n        const iconPath = path.join\\(resourcesDir, icon\\);\n        expect\\(fs.existsSync\\(iconPath\\) && fs.statSync\\(iconPath\\).isFile\\(\\)\\).toBe\\(true\\);\n      }\\);\n    }\\);\n  }\\);\n\n  describe\\(\"init\\(\\)\", \\(\\) => {\n    it\\(\"should create tray instance\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      expect\\(mockTrayFn\\).toHaveBeenCalled\\(\\);\n    }\\);\n\n    it\\(\"should set tooltip on init\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setToolTip\\).toHaveBeenCalledWith\\(expect.stringContaining\\(\"Agent Operis\"\\)\\);\n    }\\);\n\n    it\\(\"should register double-click handler\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      const onCalls = lastInstance?.on.mock.calls || [];\n      expect\\(onCalls.some\\(\\(c: any[]\\) => c[0] === \"double-click\"\\)\\).toBe\\(true\\);\n    }\\);\n\n    it\\(\"should build menu on init\", \\(\\) => {\n      const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      expect\\(mockMenuBuildFromTemplate\\).toHaveBeenCalled\\(\\);\n    }\\);\n  }\\);\n\n  describe\\(\"updateGateway\\(\\)\", \\(\\) => {\n    it\\(\"should update icon on status change\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"running\"\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setImage\\).toHaveBeenCalled\\(\\);\n    }\\);\n\n    it\\(\"should update tooltip with status\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"running\"\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setToolTip\\).toHaveBeenCalledWith\\(expect.stringContaining\\(\"running\"\\)\\);\n    }\\);\n\n    it\\(\"should handle all gateway statuses\", \\(\\) => {\n      const statuses = [\"starting\", \"running\", \"stopped\", \"error\"] as const;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      statuses.forEach\\(status => {\n        const mockTrayFn = Tray as any;\n        mockTrayFn.mock.results.forEach\\(r => r.value?.setImage?.mockClear?.\\(\\)\\);\n        manager.updateGateway\\(status\\);\n\n        const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n        expect\\(lastInstance?.setImage\\).toHaveBeenCalled\\(\\);\n      }\\);\n    }\\);\n  }\\);\n\n  describe\\(\"updateTunnel\\(\\)\", \\(\\) => {\n    it\\(\"should rebuild menu on tunnel status change\", \\(\\) => {\n      const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      mockMenuBuildFromTemplate.mockClear\\(\\);\n      manager.updateTunnel\\(\"connected\"\\);\n\n      expect\\(mockMenuBuildFromTemplate\\).toHaveBeenCalled\\(\\);\n    }\\);\n\n    it\\(\"should not update icon on tunnel status change\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      mockTrayFn.mock.results.forEach\\(r => r.value?.setImage?.mockClear?.\\(\\)\\);\n      \n      manager.updateTunnel\\(\"connected\"\\);\n\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      expect\\(lastInstance?.setImage\\).not.toHaveBeenCalled\\(\\);\n    }\\);\n  }\\);\n\n  describe\\(\"Context menu structure\", \\(\\) => {\n    it\\(\"should have Show Window menu item\", \\(\\) => {\n      const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const menuTemplate = mockMenuBuildFromTemplate.mock.calls[0][0];\n      const showItem = menuTemplate.find\\(\\(item: any\\) => item.label === \"Show Window\"\\);\n      expect\\(showItem\\).toBeDefined\\(\\);\n      expect\\(showItem?.click\\).toBeDefined\\(\\);\n    }\\);\n\n    it\\(\"should have Gateway status label\", \\(\\) => {\n      const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      manager.updateGateway\\(\"running\"\\);\n\n      const lastCall = mockMenuBuildFromTemplate.mock.calls[mockMenuBuildFromTemplate.mock.calls.length - 1][0];\n      const gatewayLabel = lastCall.find\\(\\(item: any\\) => item.label?.includes\\(\"Gateway:\"\\)\\);\n      expect\\(gatewayLabel\\).toBeDefined\\(\\);\n    }\\);\n\n    it\\(\"should have Quit menu item that sets isQuitting\", \\(\\) => {\n      const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n      const mockAppObj = app as any;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const menuTemplate = mockMenuBuildFromTemplate.mock.calls[0][0];\n      const quit = menuTemplate.find\\(\\(item: any\\) => item.label === \"Quit\"\\);\n      \n      expect\\(manager.isQuitting\\).toBe\\(false\\);\n      quit?.click?.\\(\\);\n      expect\\(manager.isQuitting\\).toBe\\(true\\);\n      expect\\(mockAppObj.quit\\).toHaveBeenCalled\\(\\);\n    }\\);\n\n    it\\(\"should have all required menu items\", \\(\\) => {\n      const mockMenuBuildFromTemplate = \\(Menu as any\\).buildFromTemplate;\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const menuTemplate = mockMenuBuildFromTemplate.mock.calls[0][0];\n      const labels = menuTemplate.map\\(\\(item: any\\) => item.label\\);\n      \n      expect\\(labels\\).toContain\\(\"Show Window\"\\);\n      expect\\(labels\\).toContain\\(\"Restart Gateway\"\\);\n      expect\\(labels\\).toContain\\(\"Reconnect Tunnel\"\\);\n      expect\\(labels\\).toContain\\(\"Start on Login\"\\);\n      expect\\(labels\\).toContain\\(\"Quit\"\\);\n    }\\);\n  }\\);\n\n  describe\\(\"destroy\\(\\)\", \\(\\) => {\n    it\\(\"should call tray.destroy\\(\\) if initialized\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      \n      manager.destroy\\(\\);\n      expect\\(lastInstance?.destroy\\).toHaveBeenCalled\\(\\);\n    }\\);\n\n    it\\(\"should be safe to call destroy without init\", \\(\\) => {\n      expect\\(\\(\\) => manager.destroy\\(\\)\\).not.toThrow\\(\\);\n    }\\);\n\n    it\\(\"should be safe to call destroy multiple times\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      expect\\(\\(\\) => {\n        manager.destroy\\(\\);\n        manager.destroy\\(\\);\n      }\\).not.toThrow\\(\\);\n    }\\);\n  }\\);\n\n  describe\\(\"Double-click handler\", \\(\\) => {\n    it\\(\"should show window on tray double-click\", \\(\\) => {\n      manager.init\\(mockWindow, {\n        onRestartGateway: vi.fn\\(\\),\n        onRestartTunnel: vi.fn\\(\\),\n      }\\);\n\n      const mockTrayFn = Tray as any;\n      const lastInstance = mockTrayFn.mock.results[mockTrayFn.mock.results.length - 1]?.value;\n      const doubleClickCall = lastInstance?.on.mock.calls.find\\(\\(c: any\\) => c[0] === \"double-click\"\\);\n      \n      doubleClickCall?.[1]?.\\(\\);\n      expect\\(mockWindow.show\\).toHaveBeenCalled\\(\\);\n    }\\);\n  }\\);\n}\\);\nTESTEOF)",
      "Bash(bash:*)",
      "Bash(npm run typecheck:*)",
      "Bash(npm run build:*)",
      "Bash(Get-Date -UFormat \"%y%m%d\")",
      "Bash(npx tsc:*)",
      "Bash(git commit:*)",
      "Bash(npm run build:electron:*)",
      "Bash(npm test:*)",
      "Bash(ls:*)",
      "Bash(git add:*)"
    ]
  }
}
