# Plan: Agent Operis Windows Desktop App (Electron + NSIS)

**Date:** 2026-02-06 | **Status:** Draft | **Priority:** High

## Summary

Package Agent Operis as a Windows desktop app using Electron. Main process spawns the Node.js gateway and cloudflared as child processes, renders client-web Lit UI in BrowserWindow. NSIS installer via electron-builder. Auto-start on Windows login. First-run setup uses existing non-interactive onboarding (`--non-interactive --accept-risk`) with simple 2-token UI.

## Architecture

```
[Install] --> AgentOperis-Setup.exe (NSIS) --> %LOCALAPPDATA%/Programs/AgentOperis/

[First Run] --> [Electron Main]
  |-- detect: no config exists
  +-- show --> [BrowserWindow: First-Run Setup]
                |-- User enters: Anthropic API token + CF tunnel token
                +-- Electron calls: node dist/entry.js onboard --non-interactive ...
                      |-- writes config, skips daemon install (Electron manages lifecycle)
                      +-- done -> proceed to normal startup

[Normal Startup] --> [Electron Main Process]
  |-- spawn --> [Gateway Node.js] (127.0.0.1:18789)
  |               |-- WhatsApp (Baileys WS)
  |               |-- Telegram (grammY HTTP)
  |               +-- Zalo (undici HTTP)
  |
  |-- spawn --> [cloudflared tunnel run --token] (outbound to CF edge)
  |               +-- Public URL (fixed domain via CNAME)
  |
  +-- render --> [BrowserWindow] (client-web Lit UI)
                 +-- ws://127.0.0.1:18789

[Build Time Only] (developer, NOT user):
  pnpm install -> pnpm build (tsdown + Vite) -> electron-builder -> .exe
```

## Phases

| # | Phase | Status | File | Depends On |
|---|-------|--------|------|------------|
| 1 | Electron Project Setup + First-Run Onboarding | DONE (2026-02-07) | [phase-01](./phase-01-electron-project-setup.md) | -- |
| 2 | Gateway Process Manager | DONE (2026-02-08) | [phase-02](./phase-02-gateway-process-manager.md) | Phase 1 |
| 3 | Cloudflare Tunnel Integration | DONE (2026-02-08) | [phase-03](./phase-03-cloudflare-tunnel-integration.md) | Phase 2 |
| 4 | System Tray & Auto-Start | DONE (2026-02-08) | [phase-04](./phase-04-system-tray-auto-start.md) | Phase 2 |
| 5 | NSIS Installer & Build Pipeline | pending | [phase-05](./phase-05-nsis-installer-build.md) | Phases 1-4 |

## Dependency Graph

```
Phase 1 (Scaffold + First-Run Onboarding)
  +-> Phase 2 (Gateway Manager)
  |     +-> Phase 3 (CF Tunnel)
  |     +-> Phase 4 (Tray + Auto-Start)
  |           |
  +-----------+-> Phase 5 (NSIS Build)
```

## Key Decisions

1. **child_process.spawn** over UtilityProcess -- gateway runs as separate Node, not embedded in Electron
2. **extraResources** for gateway dist/ + cloudflared.exe -- outside ASAR
3. **setLoginItemSettings** for auto-start -- simpler than schtasks, NSIS cleans registry on uninstall
4. **Download-on-first-run** for cloudflared with bundled fallback
5. **safeStorage** for CF tunnel token encryption
6. **Non-interactive onboarding** for first-run -- codebase already has full support via `src/commands/onboard-non-interactive.ts`. Electron shows simple setup UI (2 tokens), then calls `node dist/entry.js onboard --non-interactive --accept-risk ...`
7. **Build-time vs runtime separation** -- `pnpm install` + `pnpm build` are BUILD TIME only (developer machine). Users install via .exe and never touch CLI. Electron handles all process lifecycle.
8. **No daemon install** -- `--install-daemon=false` because Electron itself manages gateway lifecycle (no need for schtasks)

## Key Discovery: Non-Interactive Onboarding

The codebase already supports fully automated onboarding:

| File | Purpose |
|------|---------|
| `src/commands/onboard-non-interactive.ts` | Entry: `runNonInteractiveOnboarding(opts, runtime)` |
| `src/commands/onboard-non-interactive/local.ts` | Full flow: workspace -> auth -> gateway config -> write config -> daemon |
| `src/commands/onboard-types.ts` | `OnboardOptions` type with all flags |
| `src/cli/program/register.onboard.ts` | CLI flag registration |

**Silent onboard command for Electron first-run:**
```
node dist/entry.js onboard \
  --non-interactive --accept-risk \
  --auth-choice setup-token --token <ANTHROPIC_TOKEN> \
  --gateway-port 18789 --gateway-bind loopback \
  --gateway-auth token --gateway-token <auto-generated> \
  --skip-channels --skip-skills \
  --install-daemon=false \
  --json
```

## Research

- [Electron + NSIS Research](./research/researcher-01-electron-nsis.md)
- [Cloudflare Tunnel Research](./research/researcher-02-cloudflare-tunnel.md)
- [Codebase Scout Report](./scout/scout-01-codebase-analysis.md)
- [Brainstorm Report](../reports/brainstorm-260206-desktop-exe-packaging.md)

## Estimated Effort

- Phase 1: 2-3 days (includes first-run onboarding UI)
- Phase 2: 2-3 days
- Phase 3: 2-3 days
- Phase 4: 1 day
- Phase 5: 1-2 days
- **Total: ~9-12 days**
